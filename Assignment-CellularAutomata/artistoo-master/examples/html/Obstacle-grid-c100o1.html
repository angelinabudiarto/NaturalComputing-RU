<!-- Page setup and title -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html;
charset=UTF-8">
    <title>Obstacles (Group 8)</title>
    <style type="text/css">
        body {
            font-family: "HelveticaNeue-Light", sans-serif;
            padding: 15px;
        }
    </style>

    <!-- Sourcing the cpm build -->
    <script src="../../build/artistoo.js"></script>
    <script src="fpsmeter.min.js"></script>
    <script>
        "use strict"

        // Simulation code here.
        let config = {

            // Grid settings
            ndim: 2,
            field_size: [250, 250],

            // CPM parameters and configuration
            conf: {
                torus : [true, true],
                seed : 2021,
                T: 20,                                // CPM temperature

                // Adhesion parameters:
                J: [[0, 20, 20], [20, 0, 20], [20, 20, 0]],

                // VolumeConstraint parameters
                LAMBDA_V: [0, 50, 200],                // VolumeConstraint importance per cellkind
                V: [0, 500, 250],                    // Target volume of each cellkind

                LAMBDA_P: [0, 2, 100],
                P : [0, 340, 80],

                LAMBDA_ACT : [0,400,0],
                MAX_ACT : [0,80,0],
                ACT_MEAN : "geometric"


            },
            
            // Simulation setup and configuration
            simsettings: {
                // Cells on the grid
                NRCELLS: [1,1],                    // Number of cells to seed for all
                // non-background cellkinds.
                
                BURNIN : 500,
                RUNTIME: 1000,                  // Only used in node

                CANVASCOLOR: "eaecef",
                CELLCOLOR: ["000000", "FF0000"],
                ACTCOLOR: [true, false],
                SHOWBORDERS: [true, true],
                BORDERCOL: ["00FF00", "0000FF"],
                zoom: 2,                        // zoom in on canvas with this factor.
                
                SAVEIMG : true,
                IMGFRAMERATE: 1,
                SAVEPATH : "output/img/Obstacle-grid-c100o1",    // ... And save the image in this folder.
                EXPNAME : "Obstacle-grid-c100o1",                    // Used for the filename of output images.
                STATSOUT : { browser: true, node: true },
                LOGRATE : 10
            }
        }

        let sim, meter
        
        function initialize() {
            let custommethods = {
                initializeGrid : initializeGrid
            }
            sim = new CPM.Simulation( config, custommethods, { logStats: logStats } )
            meter = new FPSMeter({left:"auto", right:"5px"})
            step()
        }

        function step(){
            sim.step()
            meter.tick()
            requestAnimationFrame( step )
        }
        
        class PercentageActive extends CPM.Stat {
            computePercentageOfCell( cid, cellpixels ){
                const current_pixels = cellpixels[cid]
                const totalPixels = current_pixels.length

                let activePixels = 0
                for( let i = 0; i < current_pixels.length; i++ ){
                    const pos = this.M.grid.p2i( current_pixels[i] )
                    if( this.M.getConstraint( "ActivityConstraint" ).pxact( pos ) > 0 ){
                        activePixels++
                    }
                }

                return ( 100 * activePixels / totalPixels )
           }

            compute(){
                const cellpixels = this.M.getStat( CPM.PixelsByCell )
                let percentages = {}
                for( let cid of this.M.cellIDs() ){
                    percentages[cid] = this.computePercentageOfCell( cid, cellpixels )
                }
                return percentages
            }
        }

        function logStats() {
                const allpercentages = this.C.getStat( PercentageActive )
                for( let cid of this.C.cellIDs() ){
                    let theperc = allpercentages[cid]
                    console.log( this.time + "\t" + cid + "\t" +
                        this.C.cellKind(cid) + "\t" + theperc )
                }
        }
        
        function initializeGrid(){

		    // add the GridManipulator if not already there and if you need it
            if( !this.helpClasses["gm"] ){ this.addGridManipulator() }

            let num_cells = 100 

            var ni = 0
            for(ni = 0; ni < num_cells; ni++){this.gm.seedCell(1)}

            let radius = 5
            let num_obstacles = 2

            let side_i = 250 
            let side_j = 250 
            var i = 0
            var j = 0

            for(i = side_i/num_obstacles; i < side_i; i += (side_i/num_obstacles)){
                for(j = side_i/num_obstacles; j < side_j; j += (side_j/num_obstacles)){
                    let circ = this.gm.makeCircle( [Math.round(i),Math.round(j)], radius )
                    this.gm.assignCellPixels( circ, 2)
                }
            }
        }




    </script>
</head>

<body onload="initialize()">
    <h1>Obstacle simulation - grid, 100 cells, 1 obstacle</h1>
    <p>Group 8 - Natural Computing, RU</p>
</body>

</html>
